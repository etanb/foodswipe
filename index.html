<!DOCTYPE html> 
<html> 
  <head> 
  <title>My Page</title> 
  <!-- jQuery UI to Mobile conversion: http://touchpunch.furf.com/ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.css">
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.4.2/jquery.mobile-1.4.2.min.js"></script>
  <style>

  </style>
</head> 
<body> 

<div data-role="page">
  <div data-role="main" class="ui-content">
    
    
  </div>
  <div data-role="header">
    <h1>FoodSwipe</h1>
  </div><!-- /header -->

  <div data-role="content">  
    <div id="swipe-container">
    <div id="loading-screen">
      <img src="http://i.imgur.com/Tony9TT.gif" />
      <h3>Loading food for your fat ass...</h3>
    </div>
  </div>
  <div id="button-container">
    <button id="swipe-decline" data-inline="true">Crap!</button>
    <button id="swipe-accept"  data-inline="true">Tasty!</button>
    <a href="#myPopup" data-transition="slidefade" data-rel="popup" data-position-to="window" data-inline="true" data-corners="true" data-shadow="true" data-iconshadow="true" ></a>
    <div data-role="popup" id="myPopup">
      <p>We found you a place to eat! Yahoo!</p>
    </div>
  </div>  
  </div><!-- /content -->
</div><!-- /page -->

</body>

<script>
var foodIndex = 0
var likedFoodsArray = [];
var foodImageArray = [];

if (navigator.geolocation) {
  var timeoutVal = 10 * 1000 * 1000;
  navigator.geolocation.getCurrentPosition(
    getZipcode, 
    displayError,
    { enableHighAccuracy: true, timeout: timeoutVal, maximumAge: 0 }
  );
}
else {
  alert("Geolocation is not supported by this browser");
}

function getZipcode(position) {
  $.getJSON( "http://maps.googleapis.com/maps/api/geocode/json?latlng=" + position.coords.latitude + "," + position.coords.longitude, function( data ) {
    var user_zipcode = data.results[0].formatted_address
    localFoods(user_zipcode)
  });
  
}

function displayError(error) {
  var errors = { 
    1: 'Permission denied',
    2: 'Position unavailable',
    3: 'Request timeout'
  };
  alert("Error: " + errors[error.code]);
}

function localFoods(user_zipcode) {
  // console.log("TESTING" + user_zipcode)
  $.ajax({
    "url":"https://www.kimonolabs.com/api/21y8a2sa?apikey=Bd2gV40nhcS2JS9aK2slJ56DSpbGlMhh&kimpath4=" + user_zipcode + "&callback=kimonoCallback",
    "crossDomain":true,
    "dataType":"jsonp"
  });
}

function kimonoCallback(data) {
  var limit = 8
  for (i = 0; i < limit; i++) {
    var foodImage = data.results.collection1[i]
    var foodPlace = data.results.collection1[i].FoodPlace[1].text
    console.log(foodImage.FoodImage.alt)
    foodImageArray.push(foodImage)
  }
  imageAdvancer(foodIndex)
}

$("#swipe-decline").click(function () {
  imageAdvancer(foodIndex)
  foodIndex++
})

$("#swipe-accept").click(function () {
  var foodImage = foodImageArray[foodIndex].FoodImage.src
  var foodText = foodImageArray[foodIndex].FoodImage.alt
  var foodPlace = foodImageArray[foodIndex].FoodPlace[1].text
  if ($.inArray( foodPlace, likedFoodsArray ) != -1 && likedFoodsArray.length != 0) {
    console.log("MATCH! MATCH!")
    $( "#myPopup" ).text(foodText)
    $( "#myPopup" ).prepend("<img src='" + foodImage + "' />")
    $( "#myPopup" ).popup( "open" );
    $( "#match-selector" ).popup({ transition: "pop" });
  } 
  likedFoodsArray.push(foodPlace)
  imageAdvancer(foodIndex)
  foodIndex++
})

function imageAdvancer (foodIndex) {
  var foodImage = foodImageArray[foodIndex]
  foodImageCreator(foodImage)
}

function foodImageCreator(foodImage) {

  $(".food-image").remove()
  $("#loading-screen").remove()
  $( "<p class='food-image'><img src='" + foodImage.FoodImage.src + "'</p>" ).appendTo( $( "#swipe-container" ) );
}

  
</script>
</html>

